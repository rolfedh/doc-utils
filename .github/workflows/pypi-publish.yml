name: Publish Python 🐍 distribution 📦 to PyPI and GitHub

on:
  push:
    tags:
      - 'v*'  # Only run on version tags like v0.1.0

jobs:
  build-and-publish:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip build twine

      - name: Build package
        run: |
          python -m build

      - name: Publish to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_SECRET }}
        run: |
          python -m twine upload dist/*

      - name: Extract release notes
        id: extract_notes
        run: |
          # Extract the release notes for this version from CHANGELOG.md
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          
          # Extract release notes between this version and the next header
          awk "/^## \[$VERSION\]/{flag=1; next} /^## \[/{flag=0} flag" CHANGELOG.md > release_notes.md
          
          # If no specific notes found, use a default message
          if [ ! -s release_notes.md ]; then
            echo "Release $VERSION" > release_notes.md
            echo "" >> release_notes.md
            echo "See CHANGELOG.md for details." >> release_notes.md
          fi

      - name: Check if release exists
        id: check_release
        run: |
          if gh release view ${GITHUB_REF#refs/tags/} &>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Release already exists for ${GITHUB_REF#refs/tags/}"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Release does not exist for ${GITHUB_REF#refs/tags/}"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub Release
        if: steps.check_release.outputs.exists == 'false'
        uses: softprops/action-gh-release@v1
        with:
          body_path: release_notes.md
          files: dist/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload assets to existing release
        if: steps.check_release.outputs.exists == 'true'
        run: |
          # Upload distribution files to existing release
          for file in dist/*; do
            gh release upload ${GITHUB_REF#refs/tags/} "$file" --clobber
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
